1. deepdoc/parser/pdf_parser.py: __images__,
 __ocr, _layouts_rec, _table_transformer_job, _text_merge,\
 _concat_downward, _extract_table_figure, __call__

2. deepdoc/vision/ocr.py: load_model, TextDetector, TextRecognizer,
 OCR.get_rotate_crop_image, OCR.detect/recognize_v

3. deepdoc/vision/layout_recognizer.py: LayoutRecognizer.__call__,
 LayoutRecognizer4YOLOv10.preprocess/postprocess.

4. deepdoc/vision/recognizer.py: Recognizer.__call__/preprocess/postprocess -> abstraction ONNX

5. deepdoc/vision/table_structure_recognizer.py: __call__, construct_table.

Input (PDF / Image / DOCX / PPT / HTML / TXT)
  ‚îú‚îÄ If PDF/Image:
  ‚îÇ   ‚îú‚îÄ Render page images (+ dedupe chars from PDF if available)
  ‚îÇ   ‚îú‚îÄ OCR:
  ‚îÇ   ‚îÇ   ‚îú‚îÄ TextDetector (DB ONNX) ‚Üí boxes
  ‚îÇ   ‚îÇ   ‚îî‚îÄ TextRecognizer (CTC ONNX) ‚Üí text per box (rotate-crop)
  ‚îÇ   ‚îú‚îÄ Layout Detection (YOLOv10 ONNX) ‚Üí layout types per region
  ‚îÇ   ‚îú‚îÄ Table Structure (TSR ONNX) ‚Üí rows/columns/headers/spanning
  ‚îÇ   ‚îú‚îÄ Merge text blocks (rules + XGBoost concat)
  ‚îÇ   ‚îú‚îÄ Extract Figures/Tables:
  ‚îÇ   ‚îÇ   ‚îú‚îÄ Crop regions (+ captions)
  ‚îÇ   ‚îÇ   ‚îî‚îÄ Tables ‚Üí HTML or descriptive text
  ‚îÇ   ‚îî‚îÄ Output: text (with position tags) + tables/figures (+ positions)
  ‚îî‚îÄ Else if DOCX/PPT/HTML/TXT:
      ‚îú‚îÄ Use corresponding parser (no OCR)
      ‚îî‚îÄ Output: sections + optional tables/media

1. __images__():
## **üéØ M·ª•c ti√™u c·ªßa `__images__()`**
Chuy·ªÉn ƒë·ªïi PDF th√†nh ·∫£nh v√† chu·∫©n b·ªã d·ªØ li·ªáu cho OCR x·ª≠ l√Ω.

## **üìã Lu·ªìng ho·∫°t ƒë·ªông ch√≠nh**

### **B∆∞·ªõc 1: Render PDF ‚Üí ·∫¢nh**
```python
# Input: PDF file
# Output: Danh s√°ch ·∫£nh PIL cho m·ªói trang
self.page_images = [p.to_image(resolution=72 * zoomin) for p in pdf.pages]
```

**V√≠ d·ª•:**
- PDF c√≥ 3 trang ‚Üí `page_images = [img_page1, img_page2, img_page3]`
- M·ªói ·∫£nh c√≥ ƒë·ªô ph√¢n gi·∫£i 216 DPI (72 √ó 3)

### **B∆∞·ªõc 2: Tr√≠ch xu·∫•t characters g·ªëc t·ª´ PDF**
```python
# Tr√≠ch xu·∫•t text g·ªëc t·ª´ PDF (kh√¥ng qua OCR)
self.page_chars = [[char1, char2, ...], [char1, char2, ...], ...]
```

**V√≠ d·ª•:**
```python
self.page_chars = [
    [{"text": "H", "x0": 100, "y0": 50}, {"text": "e", "x0": 108, "y0": 50}, ...],  # Trang 1
    [{"text": "X", "x0": 100, "y0": 50}, {"text": "i", "x0": 108, "y0": 50}, ...],  # Trang 2
    [{"text": "A", "x0": 100, "y0": 50}, {"text": "B", "x0": 108, "y0": 50}, ...]   # Trang 3
]
```

### **B∆∞·ªõc 3: Ph√°t hi·ªán ng√¥n ng·ªØ**
```python
# Ki·ªÉm tra t·ª´ng trang c√≥ ph·∫£i ti·∫øng Anh kh√¥ng
self.is_english = [True/False, True/False, True/False]
```

**V√≠ d·ª•:**
- Trang 1: "Hello World" ‚Üí `True` (ti·∫øng Anh)
- Trang 2: "Xin ch√†o" ‚Üí `False` (ti·∫øng Vi·ªát)  
- Trang 3: "Good morning" ‚Üí `True` (ti·∫øng Anh)
- **K·∫øt qu·∫£**: `self.is_english = True` (>50% l√† ti·∫øng Anh)

### **B∆∞·ªõc 4: X·ª≠ l√Ω song song cho t·ª´ng trang**

**V·ªõi m·ªói trang:**

#### **4a. Chu·∫©n b·ªã d·ªØ li·ªáu**
```python
chars = self.page_chars[i] if not self.is_english else []
```

**V√≠ d·ª•:**
- V√¨ `is_english = True` ‚Üí `chars = []` (r·ªóng cho t·∫•t c·∫£ trang)

#### **4b. C·∫£i thi·ªán spacing (n·∫øu c√≥ chars)**
```python
# Th√™m space gi·ªØa c√°c t·ª´ n·∫øu c·∫ßn
# V√≠ d·ª•: "HelloWorld" ‚Üí "Hello World"
```

#### **4c. G·ªçi OCR**
```python
self.__ocr(page_num, image, chars, zoom_factor, device_id)
```

## **üîÑ Lu·ªìng x·ª≠ l√Ω trong `__ocr()`**

### **Input:**
- `page_num`: S·ªë trang (1, 2, 3...)
- `image`: ·∫¢nh PIL c·ªßa trang
- `chars`: Characters g·ªëc t·ª´ PDF (r·ªóng n·∫øu ti·∫øng Anh)
- `zoom_factor`: 3 (h·ªá s·ªë ph√≥ng to)

### **X·ª≠ l√Ω:**

#### **1. Text Detection**
```python
# OCR ph√°t hi·ªán v√πng ch·ª©a text
boxes = ocr.detect(image)
# V√≠ d·ª•: [box1, box2, box3] - 3 v√πng text ƒë∆∞·ª£c ph√°t hi·ªán
```

#### **2. Merge v·ªõi PDF characters (n·∫øu c√≥)**
```python
# N·∫øu chars r·ªóng ‚Üí b·ªè qua b∆∞·ªõc n√†y
# N·∫øu chars c√≥ d·ªØ li·ªáu ‚Üí g√°n characters v√†o OCR boxes
```

#### **3. Text Recognition**
```python
# Nh·∫≠n d·∫°ng n·ªôi dung text trong m·ªói v√πng
for box in boxes:
    if not box["text"]:  # Ch∆∞a c√≥ text (t·ª´ PDF)
        text = ocr.recognize(box["image"])  # OCR nh·∫≠n d·∫°ng
        box["text"] = text
```

### **Output:**
```python
# Danh s√°ch boxes v·ªõi text ƒë√£ nh·∫≠n d·∫°ng
self.boxes[page_num-1] = [
    {"x0": 100, "y0": 50, "text": "Hello"},
    {"x0": 200, "y0": 50, "text": "World"},
    {"x0": 300, "y0": 100, "text": "Sample"}
]
```

## **üìù V√≠ d·ª• ho√†n ch·ªânh**

### **Input:** PDF c√≥ 2 trang
- Trang 1: "Hello World"
- Trang 2: "Good Morning"

### **Lu·ªìng x·ª≠ l√Ω:**

#### **1. Render ·∫£nh:**
```python
page_images = [img_page1, img_page2]
```

#### **2. Tr√≠ch xu·∫•t characters:**
```python
page_chars = [
    [{"text": "H"}, {"text": "e"}, {"text": "l"}, ...],  # Trang 1
    [{"text": "G"}, {"text": "o"}, {"text": "o"}, ...]   # Trang 2
]
```

#### **3. Ph√°t hi·ªán ng√¥n ng·ªØ:**
```python
is_english = True  # C·∫£ 2 trang ƒë·ªÅu ti·∫øng Anh
```

#### **4. X·ª≠ l√Ω song song:**

**Trang 1:**
```python
chars = []  # R·ªóng v√¨ ti·∫øng Anh
ocr_boxes = [
    {"x0": 100, "y0": 50, "text": "Hello"},
    {"x0": 200, "y0": 50, "text": "World"}
]
```

**Trang 2:**
```python
chars = []  # R·ªóng v√¨ ti·∫øng Anh
ocr_boxes = [
    {"x0": 100, "y0": 50, "text": "Good"},
    {"x0": 200, "y0": 50, "text": "Morning"}
]
```

#### **5. K·∫øt qu·∫£ cu·ªëi:**
```python
self.boxes = [
    [{"text": "Hello"}, {"text": "World"}],      # Trang 1
    [{"text": "Good"}, {"text": "Morning"}]      # Trang 2
]
```

## **üéØ T√≥m t·∫Øt ng·∫Øn g·ªçn**

1. **PDF ‚Üí ·∫¢nh**: Render t·ª´ng trang th√†nh ·∫£nh
2. **Tr√≠ch text g·ªëc**: L·∫•y characters t·ª´ PDF (n·∫øu c√≥)
3. **Ph√°t hi·ªán ng√¥n ng·ªØ**: Ti·∫øng Anh hay kh√¥ng?
4. **X·ª≠ l√Ω song song**: OCR t·ª´ng trang ƒë·ªìng th·ªùi
5. **K·∫øt h·ª£p**: OCR detection + PDF text (n·∫øu c·∫ßn)
6. **K·∫øt qu·∫£**: Danh s√°ch text boxes v·ªõi n·ªôi dung ƒë√£ nh·∫≠n d·∫°ng

**ƒêi·ªÉm quan tr·ªçng:**
- **Ti·∫øng Anh**: D√πng OCR thu·∫ßn (nhanh)
- **Kh√¥ng ti·∫øng Anh**: K·∫øt h·ª£p PDF text + OCR (ch√≠nh x√°c)
